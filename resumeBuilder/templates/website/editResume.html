{% extends "base.html" %}

{% block title %}Edit Resume - Resume Builder{% endblock %}
{% block content %}

<div class="min-h-screen bg-gray-100 py-10">
  <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-lg p-8">
    <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Edit Resume</h2>

    <form method="POST" enctype="multipart/form-data" class="space-y-8">
      {% csrf_token %}

      <!-- BASIC INFO -->
      <section>
        <h3 class="text-xl font-semibold text-green-600 border-b pb-2 mb-4">Basic Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" name="full_name" value="{{ resume.full_name }}" placeholder="Full Name" class="border rounded p-2 w-full">
          <input type="email" name="email" value="{{ resume.email }}" placeholder="Email" class="border rounded p-2 w-full">
          <input type="text" name="phone" value="{{ resume.phone }}" placeholder="Phone" class="border rounded p-2 w-full">
          <input type="text" name="address" value="{{ resume.address }}" placeholder="Address" class="border rounded p-2 w-full">
          <input type="text" name="occupation" value="{{ resume.occupation }}" placeholder="Occupation" class="border rounded p-2 w-full">
        </div>
        <textarea name="summary" rows="4" placeholder="Professional Summary" class="border rounded p-2 w-full mt-4">{{ resume.summary }}</textarea>
      </section>

      <!-- IMAGE -->
      <section>
        <h3 class="text-xl font-semibold text-green-600 border-b pb-2 mb-4">Profile Image</h3>
        <div class="flex items-center gap-4">
          {% if resume.image %}
            <img id="imagePreview" src="{{ resume.image.url }}" class="w-24 h-24 rounded-full object-cover border" alt="Profile Image">
          {% else %}
            <img id="imagePreview" src="https://via.placeholder.com/100" class="w-24 h-24 rounded-full object-cover border" alt="Profile Image">
          {% endif %}
          <input type="file" name="image" id="imageInput" accept="image/*" class="block">
        </div>
      </section>

      <!-- CONTACT DETAILS -->
      <section>
        <h3 class="text-xl font-semibold text-green-600 border-b pb-2 mb-4">Contact Details</h3>
        <div id="contactFields" class="space-y-2">
          {% for c in contacts %}
          <div class="flex gap-2">
            <input type="text" name="contact_type[]" value="{{ c.contact_type }}" placeholder="Type (e.g., LinkedIn)" class="border rounded p-2 w-1/2">
            <input type="text" name="contact_value[]" value="{{ c.contact_value }}" placeholder="Value" class="border rounded p-2 w-1/2">
          </div>
          {% endfor %}
        </div>
        <button type="button" onclick="addContact()" class="mt-3 bg-gray-200 px-3 py-1 rounded">+ Add Contact</button>
      </section>

      <!-- WORK EXPERIENCE -->
      <section>
        <h3 class="text-xl font-semibold text-green-600 border-b pb-2 mb-4">Work Experience</h3>
        <div id="experienceFields" class="space-y-4">
          {% for exp in experiences %}
          <div class="border p-4 rounded space-y-2">
            <input type="text" name="job_title[]" value="{{ exp.job_title }}" placeholder="Job Title" class="border rounded p-2 w-full">
            <input type="text" name="company[]" value="{{ exp.company }}" placeholder="Company" class="border rounded p-2 w-full">
            <input type="text" name="job_location[]" value="{{ exp.location }}" placeholder="Location" class="border rounded p-2 w-full">
            <div class="flex gap-2">
              <input type="month" name="job_start_date[]" value="{{ exp.start_date|date:'Y-m' }}" class="border rounded p-2 w-1/2">
              <input type="month" name="job_end_date[]" value="{{ exp.end_date|date:'Y-m' }}" class="border rounded p-2 w-1/2">
            </div>
            <label><input type="checkbox" name="current_job_{{ forloop.counter0 }}" {% if exp.is_current %}checked{% endif %}> Currently Working</label>
            <textarea name="job_description[]" rows="3" placeholder="Job Description" class="border rounded p-2 w-full">{{ exp.description }}</textarea>
          </div>
          {% endfor %}
        </div>
        <button type="button" onclick="addExperience()" class="mt-3 bg-gray-200 px-3 py-1 rounded">+ Add Experience</button>
      </section>

      <!-- EDUCATION -->
      <section>
        <h3 class="text-xl font-semibold text-green-600 border-b pb-2 mb-4">Education</h3>
        <div id="educationFields" class="space-y-4">
          {% for edu in educations %}
          <div class="border p-4 rounded space-y-2">
            <input type="text" name="degree[]" value="{{ edu.degree }}" placeholder="Degree" class="border rounded p-2 w-full">
            <input type="text" name="institution[]" value="{{ edu.institution }}" placeholder="Institution" class="border rounded p-2 w-full">
            <input type="text" name="edu_location[]" value="{{ edu.location }}" placeholder="Location" class="border rounded p-2 w-full">
            <div class="flex gap-2">
              <input type="month" name="edu_start_date[]" value="{{ edu.start_date|date:'Y-m' }}" class="border rounded p-2 w-1/2">
              <input type="month" name="edu_end_date[]" value="{{ edu.end_date|date:'Y-m' }}" class="border rounded p-2 w-1/2">
            </div>
            <label><input type="checkbox" name="current_edu_{{ forloop.counter0 }}" {% if edu.is_current %}checked{% endif %}> Currently Studying</label>
            <textarea name="edu_description[]" rows="3" placeholder="Description" class="border rounded p-2 w-full">{{ edu.description }}</textarea>
          </div>
          {% endfor %}
        </div>
        <button type="button" onclick="addEducation()" class="mt-3 bg-gray-200 px-3 py-1 rounded">+ Add Education</button>
      </section>

      <!-- PROGRAMMING SKILLS -->
      <section>
        <h3 class="text-xl font-semibold text-green-600 border-b pb-2 mb-4">Programming Skills</h3>
        <div id="progSkillFields" class="space-y-2">
          {% for ps in programming_skills %}
          <div class="flex gap-2">
            <input type="text" name="programming_skill[]" value="{{ ps.skill_name }}" placeholder="Skill" class="border rounded p-2 w-1/2">
            <select name="programming_level[]" class="border rounded p-2 w-1/2">
                {% for code, label in programming_level_choices %}
                <option value="{{ code }}" {% if ps.level == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
          </div>
          {% endfor %}
        </div>
        <button type="button" onclick="addProgSkill()" class="mt-3 bg-gray-200 px-3 py-1 rounded">+ Add Skill</button>
      </section>

      <!-- LANGUAGES -->
      <section>
        <h3 class="text-xl font-semibold text-green-600 border-b pb-2 mb-4">Languages</h3>
        <div id="langFields" class="space-y-2">
          {% for lang in languages %}
          <div class="flex gap-2">
            <input type="text" name="language[]" value="{{ lang.language }}" placeholder="Language" class="border rounded p-2 w-1/2">
            <select name="language_level[]" class="border rounded p-2 w-1/2">
                {% for code, label in language_level_choices %}
                <option value="{{ code }}" {% if lang.level == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
          </div>
          {% endfor %}
        </div>
        <button type="button" onclick="addLanguage()" class="mt-3 bg-gray-200 px-3 py-1 rounded">+ Add Language</button>
      </section>


      <!--Projects-->
      <section>
        <h3 class="text-xl font-semibold text-green-600 border-b pb-2 mb-4">Projects</h3>
        <div id="projectFields" class="space-y-4">
            {% for project in projects %}
            <div class="project-entry border p-4 rounded bg-gray-50 space-y-3">
              <div>
                <label class="block mb-1 text-700 font-medium">Project Title</label>
                <input type="text" name="project_title[]" value="{{ project.title }}" placeholder="e.g. E-commerce Website" class="w-full border px-3 py-2 rounded shadow-sm">
              </div>
              <div>
                <label class="block mb-1 text-700 font-medium">Description</label>
                <textarea name="project_description[]" rows="3" placeholder="Describe your project, technologies used, and achievements" class="w-full border px-3 py-2 rounded shadow-sm">{{ project.description }}</textarea>
              </div>
              <div>
                <label class="block mb-1 text-700 font-medium">Project URL (Optional)</label>
                <input type="url" name="project_link[]" value="{{ project.link }}" placeholder="https://github.com/yourproject or https://yourproject.com" class="w-full border px-3 py-2 rounded shadow-sm">
              </div>
              <div class="flex justify-end">
                <button type="button" onclick="removeProject(this)" class="text-red-500 hover:text-red-700 px-2 py-1 text-sm">Remove Project</button>
              </div>
            </div>
            {% empty %}
            <div class="project-entry border p-4 rounded bg-gray-50 space-y-3">
              <div>
                <label class="block mb-1 text-700 font-medium">Project Title</label>
                <input type="text" name="project_title[]" placeholder="e.g. E-commerce Website" class="w-full border px-3 py-2 rounded shadow-sm">
              </div>
              <div>
                <label class="block mb-1 text-700 font-medium">Description</label>
                <textarea name="project_description[]" rows="3" placeholder="Describe your project, technologies used, and achievements" class="w-full border px-3 py-2 rounded shadow-sm"></textarea>
              </div>
              <div>
                <label class="block mb-1 text-700 font-medium">Project URL (Optional)</label>
                <input type="url" name="project_link[]" placeholder="https://github.com/yourproject or https://yourproject.com" class="w-full border px-3 py-2 rounded shadow-sm">
              </div>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addProject()" class="mt-3 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow">+ Add Project</button>
      </section>

      <!-- OTHER SKILLS -->
      <section>
        <h3 class="text-xl font-semibold text-green-600 border-b pb-2 mb-4">Other Skills</h3>
        <div id="otherSkillFields" class="space-y-2">
          {% for os in other_skills %}
          <input type="text" name="other_skill[]" value="{{ os.skill }}" placeholder="Skill" class="border rounded p-2 w-full">
          {% endfor %}
        </div>
        <button type="button" onclick="addOtherSkill()" class="mt-3 bg-gray-200 px-3 py-1 rounded">+ Add Skill</button>
      </section>

      <!-- SUBMIT -->
      <section>
        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">Save Changes</button>
      </section>
    </form>
  </div>
</div>

<!-- JS for Dynamic Fields & Image Preview -->
<script>
  document.getElementById('imageInput').addEventListener('change', function(e){
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = (ev) => document.getElementById('imagePreview').src = ev.target.result;
      reader.readAsDataURL(file);
    }
  });

  function addContact(){
    document.getElementById('contactFields').insertAdjacentHTML('beforeend',
      `<div class="flex gap-2">
        <input type="text" name="contact_type[]" placeholder="Type" class="border rounded p-2 w-1/2">
        <input type="text" name="contact_value[]" placeholder="Value" class="border rounded p-2 w-1/2">
      </div>`);
  }

  function addExperience(){
    document.getElementById('experienceFields').insertAdjacentHTML('beforeend',
      `<div class="border p-4 rounded space-y-2">
        <input type="text" name="job_title[]" placeholder="Job Title" class="border rounded p-2 w-full">
        <input type="text" name="company[]" placeholder="Company" class="border rounded p-2 w-full">
        <input type="text" name="job_location[]" placeholder="Location" class="border rounded p-2 w-full">
        <div class="flex gap-2">
          <input type="month" name="job_start_date[]" class="border rounded p-2 w-1/2">
          <input type="month" name="job_end_date[]" class="border rounded p-2 w-1/2">
        </div>
        <label><input type="checkbox" name="current_job_NEW"> Currently Working</label>
        <textarea name="job_description[]" rows="3" class="border rounded p-2 w-full" placeholder="Job Description"></textarea>
      </div>`);
  }

  function addEducation(){
    document.getElementById('educationFields').insertAdjacentHTML('beforeend',
      `<div class="border p-4 rounded space-y-2">
        <input type="text" name="degree[]" placeholder="Degree" class="border rounded p-2 w-full">
        <input type="text" name="institution[]" placeholder="Institution" class="border rounded p-2 w-full">
        <input type="text" name="edu_location[]" placeholder="Location" class="border rounded p-2 w-full">
        <div class="flex gap-2">
          <input type="month" name="edu_start_date[]" class="border rounded p-2 w-1/2">
          <input type="month" name="edu_end_date[]" class="border rounded p-2 w-1/2">
        </div>
        <label><input type="checkbox" name="current_edu_NEW"> Currently Studying</label>
        <textarea name="edu_description[]" rows="3" placeholder="Description" class="border rounded p-2 w-full"></textarea>
      </div>`);
  }

  function addProgSkill(){
    document.getElementById('progSkillFields').insertAdjacentHTML('beforeend',
      `<div class="flex gap-2">
        <input type="text" name="programming_skill[]" placeholder="Skill" class="border rounded p-2 w-1/2">
        <input type="text" name="programming_level[]" placeholder="Level" class="border rounded p-2 w-1/2">
      </div>`);
  }

  function addLanguage(){
    document.getElementById('langFields').insertAdjacentHTML('beforeend',
      `<div class="flex gap-2">
        <input type="text" name="language[]" placeholder="Language" class="border rounded p-2 w-1/2">
        <input type="text" name="language_level[]" placeholder="Level" class="border rounded p-2 w-1/2">
      </div>`);
  }

  function addOtherSkill(){
    document.getElementById('otherSkillFields').insertAdjacentHTML('beforeend',
      `<input type="text" name="other_skill[]" placeholder="Skill" class="border rounded p-2 w-full">`);
  }

  function addProject(){
    document.getElementById('projectFields').insertAdjacentHTML('beforeend',
      `<div class="project-entry border p-4 rounded bg-gray-50 space-y-3">
        <div>
          <label class="block mb-1 text-700 font-medium">Project Title</label>
          <input type="text" name="project_title[]" placeholder="e.g. E-commerce Website" class="w-full border px-3 py-2 rounded shadow-sm">
        </div>
        <div>
          <label class="block mb-1 text-700 font-medium">Description</label>
          <textarea name="project_description[]" rows="3" placeholder="Describe your project, technologies used, and achievements" class="w-full border px-3 py-2 rounded shadow-sm"></textarea>
        </div>
        <div>
          <label class="block mb-1 text-700 font-medium">Project URL (Optional)</label>
          <input type="url" name="project_link[]" placeholder="https://github.com/yourproject or https://yourproject.com" class="w-full border px-3 py-2 rounded shadow-sm">
        </div>
        <div class="flex justify-end">
          <button type="button" onclick="removeProject(this)" class="text-red-500 hover:text-red-700 px-2 py-1 text-sm">Remove Project</button>
        </div>
      </div>`);
  }

  function removeProject(button){
    // Only remove if there's more than one project entry
    const projectEntries = document.querySelectorAll('.project-entry');
    if (projectEntries.length > 1) {
      button.closest('.project-entry').remove();
    }
  }
</script>

{% endblock %}
